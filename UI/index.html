<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Hotel Search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap 5 CDN -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />
  <style>
    body { padding: 2rem; }
    .results-card { min-height: 200px; }
    .table-wrap { max-height: 420px; overflow: auto; }
    .muted { color: #6c757d; }
  </style>
</head>
<body>
  <div class="container-lg">
    <h1 class="mb-4">Hotel Search</h1>

    <!-- Search form -->
    <form id="searchForm" class="row g-3 needs-validation" novalidate>
      <div class="col-md-4">
        <label for="city" class="form-label">City</label>
        <input id="city" name="city" type="text" class="form-control" placeholder="e.g., Boston" />
      </div>
      <div class="col-md-4">
        <label for="state" class="form-label">State/Region</label>
        <input id="state" name="state" type="text" class="form-control" placeholder="e.g., MA" />
      </div>
      <div class="col-md-4">
        <label for="country" class="form-label">Country</label>
        <input id="country" name="country" type="text" class="form-control" placeholder="e.g., USA" />
      </div>

      <div class="col-12 d-flex gap-2">
        <button class="btn btn-primary" type="submit" id="startBtn">
          Start Search
        </button>
        <button class="btn btn-outline-secondary" type="button" id="stopBtn" disabled>
          Stop Polling
        </button>
        <div id="spinner" class="ms-2 d-none align-items-center">
          <div class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></div>
          <span>Working…</span>
        </div>
      </div>
    </form>

    <!-- Status -->
    <div class="mt-3">
      <span class="badge text-bg-info me-2" id="status">Idle</span>
      <span class="muted">searchId: <code id="searchIdLabel">—</code></span>
      <span class="muted ms-3">last update: <code id="lastUpdate">—</code></span>
      <span class="muted ms-3">rows: <code id="rowCount">0</code></span>
    </div>

    <!-- Results -->
    <div class="card mt-4 results-card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Results</strong>
        <small class="muted">Polling every 5s</small>
      </div>
      <div class="card-body p-0 table-wrap">
        <table class="table table-sm table-striped table-hover mb-0" id="resultsTable">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Alerts -->
    <div id="alertHost" class="mt-3"></div>
  </div>

  <script>
    // ======= CONFIG =======
    // If API is same origin, leave empty. Otherwise set e.g. "http://localhost:5056"
    const API_BASE = "https://localhost:62243";

    // Endpoints (customize if yours differ)
    const START_URL = `${API_BASE}/search`;
    const STOP_URL = `${API_BASE}/cancelSearch`;
    const RESULT_URL = (id) => `${API_BASE}/get?id=${id}`;

    // ======= STATE =======
    let pollTimer = null;
    let currentSearchId = '';

    // ======= DOM =======
    const form = document.getElementById("searchForm");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const spinner = document.getElementById("spinner");
    const statusEl = document.getElementById("status");
    const searchIdLabel = document.getElementById("searchIdLabel");
    const lastUpdate = document.getElementById("lastUpdate");
    const rowCount = document.getElementById("rowCount");

    const table = document.getElementById("resultsTable");
    const thead = table.querySelector("thead");
    const tbody = table.querySelector("tbody");
    const alertHost = document.getElementById("alertHost");

    // ======= HELPERS =======
    function setBusy(busy) {
      if (busy) {
        spinner.classList.remove("d-none");
        startBtn.disabled = true;
      } else {
        spinner.classList.add("d-none");
        startBtn.disabled = false;
      }
    }

    function setStatus(text, type = "info") {
      statusEl.textContent = text;
      statusEl.className = `badge text-bg-${type}`;
    }

    function showAlert(message, type = "danger") {
      const el = document.createElement("div");
      el.className = `alert alert-${type} alert-dismissible fade show`;
      el.role = "alert";
      el.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;
      alertHost.appendChild(el);
    }

    function clearTable() {
      thead.innerHTML = "";
      tbody.innerHTML = "";
      rowCount.textContent = "0";
    }

    function renderTable(data) {
      if (!Array.isArray(data)) {
        // maybe wrapped as { hotels: [...] }
        if (data && Array.isArray(data.hotels)) data = data.hotels;
        else data = [];
      }

      // Build header from the first row's keys (or use a default set)
      const keys = data.length ? Object.keys(data[0]) : [];
      if (thead.childElementCount === 0 && keys.length) {
        const tr = document.createElement("tr");
        keys.forEach(k => {
          const th = document.createElement("th");
          th.scope = "col";
          th.textContent = k;
          tr.appendChild(th);
        });
        thead.appendChild(tr);
      }

      // Body
      tbody.innerHTML = "";
      data.forEach(row => {
        const tr = document.createElement("tr");
        (keys.length ? keys : Object.keys(row)).forEach(k => {
          const td = document.createElement("td");
          const val = row[k];
          td.textContent = (val === null || val === undefined) ? "" : String(val);
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      rowCount.textContent = String(data.length);
    }

    function isoNowShort() {
      const d = new Date();
      return d.toLocaleString();
    }

    function stopPolling() {
      if (pollTimer) {
        clearInterval(pollTimer);
        pollTimer = null;
      }
      stopBtn.disabled = true;
	  
	  const cancel = async () => {
        try {
		  const res = await fetch(STOP_URL, {
			method: "POST",
			headers: { "Content-Type": "application/json" },
			body: '"' + currentSearchId + '"'
		  });
		
          if (res.status === 404) {
            // not ready yet
            setStatus("Pending…", "warning");
            return;
          }
          if (!res.ok) {
            throw new Error(`Backend returned ${res.status}`);
          }
        } catch (err) {
          setStatus("Polling error", "danger");
          showAlert(`Polling failed: ${err.message}`);
          // keep polling—could be transient
        }
      };

      // Immediate poll, then every 5s
      cancel();
    }

    function startPolling(searchId) {
      stopBtn.disabled = false;

      const poll = async () => {
        try {
          const res = await fetch(RESULT_URL(searchId), { method: "GET" });
          if (res.status === 404) {
            // not ready yet
            setStatus("Pending…", "warning");
            return;
          }
          if (!res.ok) {
            throw new Error(`Backend returned ${res.status}`);
          }
          const payload = await res.json();
          renderTable(payload);
          lastUpdate.textContent = isoNowShort();
          setStatus("Receiving results", "success");
		  
		  if (payload.isSearchCompleted) {
			clearInterval(pollTimer);
			pollTimer = null;
			stopBtn.disabled = true;
		  }
        } catch (err) {
          setStatus("Polling error", "danger");
          showAlert(`Polling failed: ${err.message}`);
          // keep polling—could be transient
        }
      };

      // Immediate poll, then every 5s
      poll();
      pollTimer = setInterval(poll, 5000);
    }

    // ======= EVENTS =======
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // Gather filters
      const city = document.getElementById("city").value.trim();
      const state = document.getElementById("state").value.trim();
      const country = document.getElementById("country").value.trim();

      clearTable();
      setBusy(true);
      setStatus("Starting…", "secondary");
      searchIdLabel.textContent = "—";
      lastUpdate.textContent = "—";

      try {
        const res = await fetch(START_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ city, state, country })
        });

        if (!res.ok) {
          const txt = await res.text().catch(() => "");
          throw new Error(`Start failed (${res.status}): ${txt || res.statusText}`);
        }

        const data = await res.json();
        const searchId = data.searchId || data.id || data.SearchId;
        if (!searchId) {
          throw new Error("No searchId returned by API.");
        }

		stopPolling();
        currentSearchId = searchId;
        searchIdLabel.textContent = searchId;
        setStatus("Polling…", "info");
        setBusy(false);
        startPolling(searchId);
      } catch (err) {
        setBusy(false);
        setStatus("Error", "danger");
        showAlert(err.message || "Failed to start search.");
      }
    });

    stopBtn.addEventListener("click", () => {
      stopPolling();
      setStatus("Stopped", "secondary");
    });
  </script>

  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN6jIeHzg7"
    crossorigin="anonymous"
  ></script>
</body>
</html>
